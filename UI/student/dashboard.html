<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroFace AI - Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --glass-bg-dark: rgba(30, 41, 59, 0.85);
            --glass-bg-light: rgba(255, 255, 255, 0.85);
            --glass-border-dark: rgba(255, 255, 255, 0.1);
            --glass-border-light: rgba(99, 102, 241, 0.1);
        }
        
        .dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #e2e8f0;
        }
        
        .light {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            color: #334155;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Updated Logo styling */
        .logo-img {
            height: 60px;
            width: auto;
            transition: all 0.3s ease;
        }
        
        .dark .logo-img {
            filter: brightness(0) invert(1);
        }
        
        .light .logo-img {
            filter: brightness(0) saturate(100%) invert(29%) sepia(79%) saturate(1656%) hue-rotate(229deg) brightness(97%) contrast(91%);
        }
        
        .panel-text {
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
            letter-spacing: 0.05em;
        }

        /* Glass card with proper theme support */
        .glass-card {
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border-dark);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .dark .glass-card {
            background: var(--glass-bg-dark);
            border-color: var(--glass-border-dark);
        }
        
        .light .glass-card {
            background: var(--glass-bg-light);
            border-color: var(--glass-border-light);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
        }
        
        .gradient-border {
            position: relative;
            border: 1px solid transparent;
        }
        
        .dark .gradient-border {
            background: linear-gradient(135deg, #0f172a, #1e1b4b) padding-box,
                        linear-gradient(135deg, #6366f1, #8b5cf6) border-box;
        }
        
        .light .gradient-border {
            background: linear-gradient(135deg, #ffffff, #f8fafc) padding-box,
                        linear-gradient(135deg, #6366f1, #8b5cf6) border-box;
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
        }
        
        .neon-glow:hover {
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
        }
        
        /* Sidebar with theme support */
        .sidebar-glass {
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .dark .sidebar-glass {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .light .sidebar-glass {
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(99, 102, 241, 0.1);
        }

        /* User dropdown with higher z-index */
        #userDropdown {
            z-index: 9999 !important;
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            margin-top: 8px !important;
        }

        /* Ensure the dropdown button container has proper stacking */
        .relative {
            position: relative !important;
            z-index: 50 !important;
        }

        /* Make sure dropdown appears above everything */
        .user-dropdown {
            z-index: 9999 !important;
        }

        .dark .user-dropdown {
            background: rgba(30, 41, 59, 0.98);
        }

        .light .user-dropdown {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        /* Notifications panel */
        .notificationsPanel {
            position: fixed;
            z-index: 9999 !important;
        }
        
        .nav-link {
            transition: all 0.3s;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent);
            transition: width 0.3s;
        }
        
        .nav-link:hover::before {
            width: 100%;
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-left: 4px solid #6366f1;
        }
        
        .stat-card {
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stat-card:hover::after {
            opacity: 1;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Fixed input and select styling for both themes */
        .input-dark, select {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #e2e8f0;
            backdrop-filter: blur(10px);
        }
        
        .light .input-dark, .light select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #334155;
        }
        
        .navbar {
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            position: relative; 
            z-index: 100; 
        }
        
        .dark .navbar {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .light .navbar {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .dark .theme-toggle {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .light .theme-toggle {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .theme-toggle:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: rotate(30deg);
        }
        
        .neuroface-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .success-toast {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }
        
        .light ::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            backdrop-filter: blur(10px);
            border-radius: 1rem;
        }
        
        .dark .modal-content {
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border-dark);
        }
        
        .light .modal-content {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border-light);
        }
        
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .dark .badge-success {
            background: rgba(16, 185, 129, 0.15);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        /* Add this to your existing CSS */
        #profileSection {
            position: relative;
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding: 1rem;
        }

        #profileSection::-webkit-scrollbar {
            width: 8px;
        }

        #profileSection::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
        }

        #profileSection::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 4px;
        }

        #profileSection::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
        }

        #profileSection .max-w-4xl {
            min-height: calc(100vh - 180px);
        }

        @media (max-width: 768px) {
            #profileSection {
                height: calc(100vh - 120px);
                padding: 0.75rem;
            }
            
            #profileSection .grid {
                gap: 1rem;
            }
        }
        
        /* Progress bar styling */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: rgba(30, 41, 59, 0.5);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        /* Calendar styling */
        .calendar-day {
            width: 14.28%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .calendar-day.present {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .calendar-day.absent {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .calendar-day.late {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .calendar-day.half-day {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .calendar-day.leave {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .calendar-day.today {
            background: rgba(99, 102, 241, 0.3);
            border: 2px solid #6366f1;
            font-weight: bold;
        }
        
        /* Legend styles */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
    </style>
</head>
<body class="dark">
    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar-glass w-60 flex-shrink-0 p-4 hidden md:block">
            <div class="sidebar-logo-container mb-8">
                <img src="../Logo.png" alt="NeuroFace AI Logo" class="logo-img">
                <div class="mt-2">
                    <p class="panel-text">STUDENT PANEL</p>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="space-y-2">
                <a href="#" class="nav-link flex items-center space-x-3 p-3 active" onclick="setActiveTab('dashboard')">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link flex items-center space-x-3 p-3" onclick="setActiveTab('attendanceRecords')">
                    <i class="fas fa-calendar-alt w-5"></i>
                    <span>Attendance Records</span>
                </a>
                <a href="#" class="nav-link flex items-center space-x-3 p-3" onclick="setActiveTab('leaveRequest')">
                    <i class="fas fa-envelope w-5"></i>
                    <span>Leave Request</span>
                    <span class="badge badge-purple ml-auto">New</span>
                </a>
                <a href="#" class="nav-link flex items-center space-x-3 p-3" onclick="showSection('profile')">
                    <i class="fas fa-user-circle w-5"></i>
                    <span>My Profile</span>
                </a>
            </nav>
            
            <!-- Divider -->
            <div class="my-6 border-t border-gray-800"></div>
            
            <!-- Quick Stats -->
            <div class="glass-card rounded-lg p-4">
                <h4 class="font-medium text-sm mb-3">This Month</h4>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Present Days</span>
                        <span class="font-semibold text-green-400" id="sidebarPresentDays">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Absent Days</span>
                        <span class="font-semibold text-red-400" id="sidebarAbsentDays">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Attendance %</span>
                        <span class="font-semibold" id="sidebarAttendancePercent">0%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Leaves Left</span>
                        <span class="font-semibold text-blue-400" id="sidebarLeavesLeft">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Footer -->
            <div class="absolute bottom-4 left-4 right-4">
                <button onclick="logout()" class="w-full p-3 rounded-lg border border-red-500 text-red-400 hover:bg-red-900/30 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>Logout</span>
                </button>
                <div class="text-center text-xs text-gray-500 mt-4">
                    <p>NeuroFace AI v2.0</p>
                    <p class="mt-1">Student Portal</p>
                </div>
            </div>
        </div>

        <!-- Mobile Header -->
        <div class="md:hidden navbar p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-800">
                        <i class="fas fa-bars text-white"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-user-graduate text-white text-sm"></i>
                        </div>
                        <h1 class="text-lg font-bold neuroface-gradient">NeuroFace AI</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="mobileThemeToggle" class="theme-toggle">
                        <i class="fas fa-moon text-white"></i>
                    </button>
                    <button onclick="logout()" class="p-2 rounded-lg border border-red-500 text-red-400 hover:bg-red-900/30">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Sidebar -->
        <div id="mobileSidebar" class="fixed inset-0 z-40 md:hidden hidden">
            <div class="absolute inset-0 bg-black bg-opacity-50" onclick="toggleSidebar()"></div>
            <div class="absolute left-0 top-0 bottom-0 w-64 p-4 sidebar-glass">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-user-graduate text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold neuroface-gradient">NeuroFace AI</h1>
                            <p class="text-xs text-gray-400">Student Panel</p>
                        </div>
                    </div>
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-800">
                        <i class="fas fa-times text-white"></i>
                    </button>
                </div>
                
                <!-- Navigation links -->
                <nav class="space-y-2 mb-6">
                    <a href="#" class="nav-link flex items-center space-x-3 p-3 active" onclick="setActiveTab('dashboard'); toggleSidebar();">
                        <i class="fas fa-tachometer-alt w-5"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-3" onclick="setActiveTab('attendanceRecords'); toggleSidebar();">
                        <i class="fas fa-calendar-alt w-5"></i>
                        <span>Attendance Records</span>
                    </a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-3" onclick="setActiveTab('leaveRequest'); toggleSidebar();">
                        <i class="fas fa-envelope w-5"></i>
                        <span>Leave Request</span>
                        <span class="badge badge-purple ml-auto">New</span>
                    </a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-3" onclick="showSection('profile')">
                        <i class="fas fa-user-circle w-5"></i>
                        <span>My Profile</span>
                    </a>
                </nav>
                
                <div class="text-center text-xs text-gray-500">
                    <p>NeuroFace AI v2.0</p>
                    <p class="mt-1">Student Portal</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header Navbar -->
            <div class="navbar p-4 hidden md:block">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold neuroface-gradient" id="pageTitle">Student Dashboard</h2>
                        <p class="text-sm text-gray-400" id="sectionSubtitle">Welcome back, Student</p>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Quick Actions -->
                        <div class="flex items-center space-x-2">
                            <button onclick="refreshDashboard()" class="p-2 rounded-lg hover:bg-gray-800" title="Refresh">
                                <i class="fas fa-sync-alt text-gray-400"></i>
                            </button>
                            <button onclick="toggleFullscreen()" class="p-2 rounded-lg hover:bg-gray-800" title="Fullscreen">
                                <i class="fas fa-expand text-gray-400"></i>
                            </button>
                        </div>
                        
                        <!-- Date/Time -->
                        <div class="text-right">
                            <div class="font-semibold" id="currentTime">Loading...</div>
                            <div class="text-sm text-gray-400" id="currentDate">Loading...</div>
                        </div>
                        
                        <!-- Theme Toggle -->
                        <button id="themeToggle" class="theme-toggle">
                            <i class="fas fa-moon" id="themeIcon"></i>
                        </button>
                        
                        <!-- User Dropdown -->
                        <div class="relative">
                            <button onclick="toggleUserDropdown()" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-800">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                    <i class="fas fa-user-graduate text-white text-sm"></i>
                                </div>
                                <div class="text-left hidden md:block">
                                    <p class="text-sm font-medium" id="studentName">Loading...</p>
                                    <p class="text-xs text-gray-400" id="studentClass">Class: Loading...</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                            </button>
                            <div id="userDropdown" class="absolute right-0 mt-2 w-48 user-dropdown rounded-lg shadow-xl hidden z-50">
                                <div class="p-4 border-b border-gray-800">
                                    <p class="font-medium" id="dropdownStudentName">Loading...</p>
                                    <p class="text-xs text-gray-400" id="dropdownStudentEmail">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showSection('profile'); toggleUserDropdown(); return false;" class="flex items-center space-x-3 p-2 rounded hover:bg-gray-800">
                                        <i class="fas fa-user-circle text-gray-400 w-5"></i>
                                        <span>My Profile</span>
                                    </a>
                                    <div class="border-t border-gray-800 mt-2 pt-2">
                                        <button onclick="logout()" class="w-full flex items-center space-x-3 p-2 rounded hover:bg-red-900/30 text-red-400">
                                            <i class="fas fa-sign-out-alt w-5"></i>
                                            <span>Logout</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Management Section -->
            <div id="profileSection" class="hidden space-y-6 fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold neuroface-gradient">My Profile</h3>
                        <p class="text-gray-400">Manage your account information and security</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Left Column - Profile Info -->
                        <div class="lg:col-span-2">
                            <div class="glass-card rounded-2xl p-6 mb-6">
                                <h4 class="text-lg font-semibold mb-6 pb-4 border-b border-gray-800">Personal Information</h4>
                                
                                <form id="profileForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Full Name</label>
                                            <input type="text" id="profileName" 
                                                class="input-dark w-full rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                placeholder="Enter your display name">
                                            <p class="text-xs text-gray-400 mt-2">This name will be displayed throughout the dashboard</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Email Address</label>
                                            <input type="email" id="profileEmail" 
                                                class="input-dark w-full rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                placeholder="Enter your email">
                                            <p class="text-xs text-gray-400 mt-2">Your login email address</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Roll Number</label>
                                            <div class="input-dark w-full rounded-lg px-4 py-3">
                                                <span class="font-medium" id="profileRollNo">S001</span>
                                                <p class="text-xs text-gray-400 mt-1">Your unique roll number</p>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Class & Stream</label>
                                            <div class="input-dark w-full rounded-lg px-4 py-3">
                                                <span class="font-medium" id="profileClassStream">Grade 10 - Science</span>
                                                <p class="text-xs text-gray-400 mt-1">Your current class and stream</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" onclick="updateProfileName()" 
                                                class="px-6 py-3 rounded-lg border border-indigo-500 text-indigo-400 hover:bg-indigo-900/30 transition">
                                            <i class="fas fa-user-edit mr-2"></i>Save Name Only
                                        </button>
                                        <button type="button" onclick="updateEmail()" 
                                                class="px-6 py-3 rounded-lg btn-primary">
                                            <i class="fas fa-save mr-2"></i>Update Email
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Password Change Section -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-lg font-semibold mb-6 pb-4 border-b border-gray-800">Change Password</h4>
                                
                                <form id="passwordForm">
                                    <div class="space-y-4 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Current Password</label>
                                            <div class="relative">
                                                <input type="password" id="currentPassword" 
                                                    class="input-dark w-full rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent pr-10"
                                                    placeholder="Enter current password" required>
                                                <button type="button" onclick="togglePasswordVisibility('currentPassword')" 
                                                        class="absolute right-3 top-3 text-gray-400 hover:text-indigo-400">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium mb-2">New Password</label>
                                            <div class="relative">
                                                <input type="password" id="newPassword" 
                                                    class="input-dark w-full rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent pr-10"
                                                    placeholder="Enter new password" required>
                                                <button type="button" onclick="togglePasswordVisibility('newPassword')" 
                                                        class="absolute right-3 top-3 text-gray-400 hover:text-indigo-400">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="mt-2">
                                                <div class="flex items-center space-x-2 mb-1">
                                                    <div id="passwordStrength" class="h-2 flex-1 rounded-full bg-gray-700"></div>
                                                    <span id="passwordStrengthText" class="text-xs text-gray-400">Weak</span>
                                                </div>
                                                <ul class="text-xs text-gray-400 space-y-1">
                                                    <li id="lengthCheck" class="flex items-center">
                                                        <i class="fas fa-times text-red-400 mr-2 text-xs"></i>
                                                        <span>At least 8 characters</span>
                                                    </li>
                                                    <li id="uppercaseCheck" class="flex items-center">
                                                        <i class="fas fa-times text-red-400 mr-2 text-xs"></i>
                                                        <span>At least one uppercase letter</span>
                                                    </li>
                                                    <li id="numberCheck" class="flex items-center">
                                                        <i class="fas fa-times text-red-400 mr-2 text-xs"></i>
                                                        <span>At least one number</span>
                                                    </li>
                                                    <li id="specialCheck" class="flex items-center">
                                                        <i class="fas fa-times text-red-400 mr-2 text-xs"></i>
                                                        <span>At least one special character</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Confirm New Password</label>
                                            <div class="relative">
                                                <input type="password" id="confirmPassword" 
                                                    class="input-dark w-full rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent pr-10"
                                                    placeholder="Confirm new password" required>
                                                <button type="button" onclick="togglePasswordVisibility('confirmPassword')" 
                                                        class="absolute right-3 top-3 text-gray-400 hover:text-indigo-400">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <p id="passwordMatch" class="text-xs text-green-400 mt-2 hidden">
                                                <i class="fas fa-check mr-1"></i>
                                                Passwords match
                                            </p>
                                            <p id="passwordMismatch" class="text-xs text-red-400 mt-2 hidden">
                                                <i class="fas fa-times mr-1"></i>
                                                Passwords do not match
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="button" onclick="changePassword()" 
                                                class="px-6 py-3 rounded-lg btn-primary">
                                            <i class="fas fa-key mr-2"></i>Update Password
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Right Column - Profile Summary -->
                        <div>
                            <div class="glass-card rounded-2xl p-6 mb-6">
                                <h4 class="text-lg font-semibold mb-6">Profile Summary</h4>
                                
                                <div class="flex flex-col items-center mb-6">
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-4">
                                        <i class="fas fa-user-graduate text-white text-3xl"></i>
                                    </div>
                                    <h5 class="text-xl font-bold" id="profileDisplayName">Loading...</h5>
                                    <p class="text-gray-400" id="profileDisplayEmail">Loading...</p>
                                    <span class="mt-2 px-3 py-1 rounded-full text-xs bg-indigo-900/30 text-indigo-400" id="profileRoleBadge">
                                        Student
                                    </span>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-400">Last Login</span>
                                        <span class="font-medium" id="profileLastLogin">Just now</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-400">Theme Preference</span>
                                        <span class="font-medium" id="profileTheme">Dark</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-400">Account Status</span>
                                        <span class="px-2 py-1 rounded text-xs bg-green-900/30 text-green-400">Active</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-400">Current Attendance</span>
                                        <span class="font-medium text-green-400" id="profileAttendance">92%</span>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Sections -->
            <div class="flex-1 overflow-auto p-4 md:p-6">
                <!-- Dashboard Section -->
                <div id="dashboardTab" class="space-y-6 fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="glass-card stat-card rounded-xl p-6 neon-glow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-sm mb-2">Overall Attendance</p>
                                    <h3 class="text-3xl font-bold mb-1" id="overallAttendancePercent">92%</h3>
                                    <p class="text-green-400 text-sm" id="attendanceStatusText">
                                        <i class="fas fa-calendar-check mr-1"></i>Excellent
                                    </p>
                                </div>
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-900/30 to-green-900/10 flex items-center justify-center">
                                    <i class="fas fa-chart-line text-green-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card stat-card rounded-xl p-6 neon-glow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-sm mb-2">This Month Present</p>
                                    <h3 class="text-3xl font-bold mb-1" id="monthPresentDays">18</h3>
                                    <p class="text-blue-400 text-sm" id="monthDetailText">
                                        <span id="monthWorkingDays">22</span> Working Days
                                    </p>
                                </div>
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-900/30 to-blue-900/10 flex items-center justify-center">
                                    <i class="fas fa-calendar-check text-blue-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card stat-card rounded-xl p-6 neon-glow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-sm mb-2">Absent This Month</p>
                                    <h3 class="text-3xl font-bold mb-1" id="monthAbsentDays">2</h3>
                                    <p class="text-yellow-400 text-sm">
                                        <i class="fas fa-user-times mr-1"></i>Leaves Used: <span id="monthLeavesUsed">1</span>
                                    </p>
                                </div>
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-yellow-900/30 to-yellow-900/10 flex items-center justify-center">
                                    <i class="fas fa-user-times text-yellow-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                    </div>

                    <!-- Charts and Calendar -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Monthly Attendance Chart -->
                        <div class="glass-card rounded-2xl p-6 lg:col-span-2">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold">Monthly Attendance Trend</h3>
                                <div class="flex space-x-2">
                                    <button onclick="loadCurrentMonthTrend()" class="px-3 py-1 rounded-lg glass-card hover:bg-gray-800/50 text-sm active">
                                        This Month
                                    </button>
                                    <button onclick="loadLastMonthTrend()" class="px-3 py-1 rounded-lg glass-card hover:bg-gray-800/50 text-sm">
                                        Last Month
                                    </button>
                                    <button onclick="loadQuarterTrend()" class="px-3 py-1 rounded-lg glass-card hover:bg-gray-800/50 text-sm">
                                        3 Months
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="attendanceTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Attendance Calendar -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold">Attendance Calendar</h3>
                                <div class="flex items-center space-x-2">
                                    <button onclick="prevMonth()" class="p-2 rounded-lg hover:bg-gray-800">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span class="font-medium" id="currentMonth">November 2024</span>
                                    <button onclick="nextMonth()" class="p-2 rounded-lg hover:bg-gray-800">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="grid grid-cols-7 gap-1 mb-2">
                                    <div class="text-center text-sm font-medium py-1">Sun</div>
                                    <div class="text-center text-sm font-medium py-1">Mon</div>
                                    <div class="text-center text-sm font-medium py-1">Tue</div>
                                    <div class="text-center text-sm font-medium py-1">Wed</div>
                                    <div class="text-center text-sm font-medium py-1">Thu</div>
                                    <div class="text-center text-sm font-medium py-1">Fri</div>
                                    <div class="text-center text-sm font-medium py-1">Sat</div>
                                </div>
                                <div id="calendarDays" class="grid grid-cols-7 gap-1">
                                    <!-- Calendar days will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Legend -->
                            <div class="mt-6 pt-4 border-t border-gray-800">
                                <h4 class="text-sm font-medium mb-3">Legend</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="legend-item">
                                        <div class="legend-color bg-green-500"></div>
                                        <span>Present</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color bg-red-500"></div>
                                        <span>Absent</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color bg-indigo-500"></div>
                                        <span>Today</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Attendance Summary -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-6">Attendance Summary</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm">Present Days</span>
                                        <span class="text-sm font-medium text-green-400">18</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 81%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm">Absent Days</span>
                                        <span class="text-sm font-medium text-red-400">2</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill bg-red-500" style="width: 9%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Attendance Section in Dashboard -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold">Recent Attendance</h3>
                                <button onclick="refreshRecentAttendance()" class="p-2 rounded-lg hover:bg-gray-800" title="Refresh">
                                    <i class="fas fa-sync-alt text-gray-400"></i>
                                </button>
                            </div>
                            <div class="space-y-3" id="recentAttendanceContainer">
                                <div id="recentAttendanceLoading" class="p-8 text-center text-gray-400">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="loading-spinner"></div>
                                        <span>Loading recent attendance...</span>
                                    </div>
                                </div>
                                <!-- Recent attendance items will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-6">Quick Actions</h3>
                            <div class="space-y-4">
                                <button onclick="setActiveTab('attendanceRecords')" class="btn-primary w-full p-4 rounded-lg flex items-center justify-center space-x-3">
                                    <i class="fas fa-calendar-alt text-xl"></i>
                                    <span>View All Records</span>
                                </button>
                                <button onclick="setActiveTab('leaveRequest')" class="glass-card w-full p-4 rounded-lg flex items-center justify-center space-x-3 hover:bg-gray-800/50 transition">
                                    <i class="fas fa-envelope text-purple-400 text-xl"></i>
                                    <span>Apply for Leave</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Records Tab -->
                <div id="attendanceRecordsTab" class="hidden space-y-6 fade-in">
                    <!-- Header -->
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold neuroface-gradient">Attendance Records</h2>
                            <p class="text-gray-400">View and filter your attendance history</p>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Month</label>
                                <select class="input-dark w-full rounded-lg px-4 py-2" id="filterMonth" onchange="filterAttendanceRecords()">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Year</label>
                                <select class="input-dark w-full rounded-lg px-4 py-2" id="filterYear" onchange="filterAttendanceRecords()">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select class="input-dark w-full rounded-lg px-4 py-2" id="filterStatus" onchange="filterAttendanceRecords()">
                                    <option value="all">All Status</option>
                                    <option value="PRESENT">Present</option>
                                    <option value="ABSENT">Absent</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Search</label>
                                <input type="text" placeholder="Search by date..." class="input-dark w-full rounded-lg px-4 py-2" 
                                       id="searchAttendance" onkeyup="filterAttendanceRecords()">
                            </div>
                        </div>
                        
                        <!-- Attendance Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Total Days</p>
                                <p class="text-2xl font-bold mt-1" id="recordsTotalDays">0</p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Present</p>
                                <p class="text-2xl font-bold text-green-400 mt-1" id="recordsPresentDays">0</p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Absent</p>
                                <p class="text-2xl font-bold text-red-400 mt-1" id="recordsAbsentDays">0</p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Attendance %</p>
                                <p class="text-2xl font-bold mt-1" id="recordsAttendancePercent">0%</p>
                            </div>
                        </div>
                        
                        <!-- Attendance Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full" id="attendanceRecordsTable">
                                <thead>
                                    <tr class="border-b border-gray-800">
                                        <th class="text-left p-4">Date</th>
                                        <th class="text-left p-4">Day</th>
                                        <th class="text-left p-4">Status</th>
                                        <th class="text-left p-4">Time In</th>
                                        <th class="text-left p-4">Remarks</th>
                                        <th class="text-left p-4">Recorded By</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceRecordsTableBody">
                                    <tr id="attendanceRecordsLoadingRow">
                                        <td colspan="7" class="p-4 text-center text-gray-400">
                                            <div class="flex items-center justify-center space-x-2">
                                                <div class="loading-spinner"></div>
                                                <span>Loading attendance records...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t border-gray-800 flex justify-between items-center">
                            <div class="text-sm text-gray-400" id="attendanceRecordsTableInfo">Loading...</div>
                            <div class="flex space-x-2" id="attendanceRecordsPagination">
                                <!-- Pagination will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leave Request Tab -->
                <div id="leaveRequestTab" class="hidden space-y-6 fade-in">
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold neuroface-gradient">Leave Request</h2>
                                <p class="text-gray-400">Apply for leave and track your requests</p>
                            </div>
                            <button onclick="openNewLeaveModal()" class="btn-primary px-6 py-3 rounded-lg flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>New Leave Request</span>
                            </button>
                        </div>
                        
                        <!-- Leave Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Total Leaves</p>
                                <p class="text-2xl font-bold mt-1" id="totalLeaves">12</p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Leaves Used</p>
                                <p class="text-2xl font-bold text-yellow-400 mt-1" id="leavesUsed">3</p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Leaves Left</p>
                                <p class="text-2xl font-bold text-green-400 mt-1" id="leavesLeft">9</p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Pending Requests</p>
                                <p class="text-2xl font-bold text-blue-400 mt-1" id="pendingRequests">1</p>
                            </div>
                        </div>
                        
                        <!-- Leave Request Form -->
                        <div class="glass-card rounded-2xl p-6 mt-6" id="leaveRequestForm">
                            <h3 class="text-lg font-semibold mb-6">Apply for Leave</h3>
                            <form id="newLeaveForm" onsubmit="event.preventDefault(); submitLeaveRequest();">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Leave Type *</label>
                                        <select id="leaveType" required class="input-dark w-full rounded-lg px-4 py-3">
                                            <option value="">Select Leave Type</option>
                                            <option value="SICK">Sick Leave</option>
                                            <option value="CASUAL">Casual Leave</option>
                                            <option value="EMERGENCY">Emergency Leave</option>
                                            <option value="PERSONAL">Personal Leave</option>
                                            <option value="OTHER">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Duration *</label>
                                        <select id="leaveDuration" required class="input-dark w-full rounded-lg px-4 py-3" onchange="toggleLeaveDuration()">
                                            <option value="SINGLE">Single Day</option>
                                            <option value="MULTIPLE">Multiple Days</option>
                                            <option value="HALF">Half Day</option>
                                        </select>
                                    </div>
                                    <div id="singleDateField">
                                        <label class="block text-sm font-medium mb-2">Date *</label>
                                        <input type="date" id="leaveSingleDate" required class="input-dark w-full rounded-lg px-4 py-3">
                                    </div>
                                    <div id="startDateField" class="hidden">
                                        <label class="block text-sm font-medium mb-2">Start Date *</label>
                                        <input type="date" id="leaveStartDate" class="input-dark w-full rounded-lg px-4 py-3">
                                    </div>
                                    <div id="endDateField" class="hidden">
                                        <label class="block text-sm font-medium mb-2">End Date *</label>
                                        <input type="date" id="leaveEndDate" class="input-dark w-full rounded-lg px-4 py-3">
                                    </div>
                                    <div id="halfDayField" class="hidden">
                                        <label class="block text-sm font-medium mb-2">Half Day *</label>
                                        <select id="leaveHalfDay" class="input-dark w-full rounded-lg px-4 py-3">
                                            <option value="FIRST_HALF">First Half (Morning)</option>
                                            <option value="SECOND_HALF">Second Half (Afternoon)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-2">Reason *</label>
                                    <textarea id="leaveReason" required rows="3" 
                                              class="input-dark w-full rounded-lg px-4 py-3"
                                              placeholder="Please provide a detailed reason for your leave..."></textarea>
                                </div>
                                
                                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-6">
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-info-circle text-blue-400 mt-1"></i>
                                        <div>
                                            <p class="text-sm text-blue-300 font-medium">Important Notes</p>
                                            <ul class="text-xs text-blue-400 mt-1 space-y-1">
                                                <li> Leave requests require at least 24 hours advance notice</li>
                                                <li> Emergency leaves can be applied on the same day</li>
                                                <li> All leaves are subject to approval by your class teacher</li>
                                                <li> You have <span class="font-bold">9 leaves</span> remaining this academic year</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3">
                                    <button type="button" onclick="resetLeaveForm()" class="px-6 py-3 rounded-lg glass-card hover:bg-gray-800/50">
                                        Cancel
                                    </button>
                                    <button type="submit" id="submitLeaveBtn" class="px-6 py-3 rounded-lg btn-primary">
                                        <span id="leaveSubmitText">Submit Leave Request</span>
                                        <div id="leaveSubmitSpinner" class="loading-spinner ml-3 hidden"></div>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Leave History -->
                        <div class="glass-card rounded-2xl p-6 mt-6">
                            <h3 class="text-lg font-semibold mb-6">Leave History</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full" id="leaveHistoryTable">
                                    <thead>
                                        <tr class="border-b border-gray-800">
                                            <th class="text-left p-4">Applied On</th>
                                            <th class="text-left p-4">Leave Dates</th>
                                            <th class="text-left p-4">Type</th>
                                            <th class="text-left p-4">Reason</th>
                                            <th class="text-left p-4">Status</th>
                                            <th class="text-left p-4">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leaveHistoryTableBody">
                                        <!-- Leave history will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg max-w-sm hidden glass-card z-50">
        <div class="flex items-center">
            <i class="fas mr-3" id="toastIcon"></i>
            <span id="toastMessage"></span>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-2xl p-8 flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-white" id="loadingText">Loading...</p>
        </div>
    </div>

    <script>
    // ==================== GLOBAL VARIABLES ====================
let currentUser = null;
let charts = {};
let currentTheme = 'dark';
let authToken = localStorage.getItem('access_token');
let currentUserId = localStorage.getItem('user_id');
let currentUserRole = localStorage.getItem('user_role');
let currentUserEmail = localStorage.getItem('user_email');
let currentUserName = localStorage.getItem('student_name');

// Calendar variables
let currentCalendarDate = new Date();

// Attendance records
let allAttendanceRecords = [];
let currentRecordsPage = 1;
const recordsPerPage = 10;

// Leave requests
let leaveRequests = [];

// API Configuration
const API_BASE_URL = 'http://localhost:8000/api/student';
const AUTH_BASE_URL = 'http://localhost:8000/auth';

// API Headers
const getHeaders = () => ({
    'Authorization': `Bearer ${authToken}`,
    'Content-Type': 'application/json'
});

// ==================== TOKEN EXPIRATION HANDLING ====================
function checkTokenExpired(response) {
    if (response.status === 401) {
        // Token expired or invalid
        showToast('Session expired. Please login again.', 'error');
        setTimeout(() => {
            logout();
        }, 2000);
        return true;
    }
    return false;
}

// ==================== AUTHENTICATION ====================
function checkAuth() {
    if (!authToken || !currentUserRole) {
        window.location.href = '/UI/register.html';
        return false;
    }
    
    // Check if user is student
    if (currentUserRole !== 'STUDENT') {
        showToast('Access denied. Student privileges required.', 'error');
        setTimeout(() => {
            window.location.href = '/UI/register.html';
        }, 2000);
        return false;
    }
    
    return true;
}

async function loadUserProfile() {
    try {
        const response = await fetch(`http://localhost:8000/users/profile`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            return;
        }
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                currentUser = data.data;
                
                // Store user information
                if (data.data.email) {
                    localStorage.setItem('user_email', data.data.email);
                    currentUserEmail = data.data.email;
                }
                
                // Use full_name from student data if available
                if (data.data.full_name) {
                    localStorage.setItem('student_name', data.data.full_name);
                    currentUserName = data.data.full_name;
                } else if (data.data.email) {
                    // If no full name, use email username
                    const emailUsername = data.data.email.split('@')[0];
                    const displayName = emailUsername
                        .split(/[._]/)
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    localStorage.setItem('student_name', displayName);
                    currentUserName = displayName;
                }
                
                // Store academic info
                if (data.data.roll_no) {
                    localStorage.setItem('student_roll_no', data.data.roll_no);
                }
                if (data.data.class) {
                    localStorage.setItem('student_class', data.data.class);
                }
                if (data.data.stream) {
                    localStorage.setItem('student_stream', data.data.stream);
                }
                
                updateUserDisplay();
            } else {
                // If API returns error, use stored data
                useStoredUserData();
            }
        } else {
            // If API fails, use stored data
            useStoredUserData();
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
        // Use stored data as fallback
        useStoredUserData();
    }
}

function useStoredUserData() {
    // Use stored data from localStorage
    const storedName = localStorage.getItem('student_name');
    const storedEmail = localStorage.getItem('user_email');
    
    if (storedName) {
        currentUserName = storedName;
    }
    if (storedEmail) {
        currentUserEmail = storedEmail;
    }
    
    updateUserDisplay();
}

function updateUserDisplay() {
    const userName = currentUserName || currentUserEmail?.split('@')[0] || 'Student';
    const displayName = userName.split(/[._]/)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    
    // Update the student name in the top-right corner
    const studentNameElement = document.getElementById('studentName');
    if (studentNameElement) {
        studentNameElement.textContent = displayName;
    }
    
    // Update the dropdown student name
    const dropdownStudentName = document.getElementById('dropdownStudentName');
    if (dropdownStudentName) {
        dropdownStudentName.textContent = displayName;
    }
    
    // Update the dropdown student email
    const dropdownStudentEmail = document.getElementById('dropdownStudentEmail');
    if (dropdownStudentEmail) {
        dropdownStudentEmail.textContent = currentUserEmail || 'Loading...';
    }
    
    // Update the section subtitle
    const sectionSubtitle = document.getElementById('sectionSubtitle');
    if (sectionSubtitle) {
        sectionSubtitle.textContent = `Welcome back, ${displayName}`;
    }
    
    // Also update the profile display name if profile section is loaded
    const profileDisplayName = document.getElementById('profileDisplayName');
    if (profileDisplayName) {
        profileDisplayName.textContent = displayName;
    }
    
    // Update student class info with stored academic data
    const studentClassElement = document.getElementById('studentClass');
    if (studentClassElement) {
        const storedClass = localStorage.getItem('student_class');
        const storedStream = localStorage.getItem('student_stream');
        
        if (storedClass && storedStream) {
            studentClassElement.textContent = `Class: ${storedClass} - ${storedStream}`;
        } else if (storedClass) {
            studentClassElement.textContent = `Class: ${storedClass}`;
        } else {
            // Fallback
            studentClassElement.textContent = 'Class: Grade 10 - Science';
        }
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    if (!checkAuth()) return;
    
    initializeClock();
    
    // Reset calendar to current date
    currentCalendarDate = new Date();
    
    // Initialize recent attendance with loading state immediately
    initializeRecentAttendance();
    
    // Load user profile first, then dashboard
    loadUserProfile().then(() => {
        // Update user display with stored data
        updateUserDisplay();
        
        // Initialize filters
        populateMonthFilter();
        populateYearFilter();
        
        // Then load dashboard data
        loadDashboardData();
        
        // Load other components
        loadAttendanceTrendChart();
        generateCalendar(); // This will now show correct month
        
        // Set active tab
        setActiveTab('dashboard');
    }).catch(error => {
        console.error('Error loading profile:', error);
        updateUserDisplay();
        populateMonthFilter();
        populateYearFilter();
        loadDashboardData();
        // Reset calendar date
        currentCalendarDate = new Date();
        generateCalendar();
        setActiveTab('dashboard');
    });
    
    // Theme setup
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') {
        toggleTheme();
    }
    
    // Event listeners
    document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
    document.getElementById('mobileThemeToggle')?.addEventListener('click', toggleTheme);
    
    // Setup other event listeners
    setupEventListeners();
});

// ==================== DASHBOARD FUNCTIONS ====================
async function loadDashboardData() {
    if (!checkAuth()) return;
    
    showLoading('Loading dashboard data...');
    
    // Initialize with loading state first
    initializeRecentAttendance();
    
    try {
        // Call dashboard stats API
        const response = await fetch(`${API_BASE_URL}/dashboard/stats`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `API error: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            updateDashboardUI(result.data);
            updateSidebarStats(result.data);
            updateUserInfo(result.data.student_info);
            
            // Store data for offline use
            localStorage.setItem('dashboard_data', JSON.stringify(result.data));
            localStorage.setItem('last_dashboard_update', new Date().toISOString());
            
            // Check if recent attendance was loaded, if not load it separately
            if (!result.data.recent_attendance || result.data.recent_attendance.length === 0) {
                await loadRecentAttendanceDirectly();
            }
            
        } else {
            throw new Error(result.message || 'Failed to load dashboard data');
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Error loading dashboard data. Please try again.', 'error');
        
        // Try to load recent attendance separately if main API fails
        await loadRecentAttendanceDirectly();
    } finally {
        hideLoading();
    }
}

// Add this new function to load recent attendance directly
async function loadRecentAttendanceDirectly() {
    try {
        const response = await fetch(`${API_BASE_URL}/attendance/records?limit=4`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.records) {
                updateRecentAttendance(result.data.records);
                return;
            }
        }
        
        // If API call fails or returns no data, show fallback
        showFallbackRecentAttendance();
        
    } catch (error) {
        console.error('Error loading recent attendance directly:', error);
        showFallbackRecentAttendance();
    }
}

async function loadRecentAttendanceFallback() {
    try {
        // Try to load recent attendance directly from API
        const response = await fetch(`${API_BASE_URL}/attendance/records?limit=4`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.records) {
                updateRecentAttendance(result.data.records);
                return;
            }
        }
        
        // If API fails, show fallback message
        showFallbackRecentAttendance();
        
    } catch (error) {
        console.error('Error loading recent attendance:', error);
        showFallbackRecentAttendance();
    }
}

function showFallbackRecentAttendance() {
    const recentContainer = document.getElementById('recentAttendanceContainer');
    const loadingElement = document.getElementById('recentAttendanceLoading');
    
    if (!recentContainer) return;
    
    // Hide loading
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
    
    // Show fallback message
    recentContainer.innerHTML = `
        <div class="p-8 text-center text-gray-400">
            <i class="fas fa-calendar-alt text-3xl mb-3"></i>
            <p class="text-lg">No recent attendance data</p>
            <p class="text-sm mt-1">Could not load attendance records</p>
            <button onclick="loadDashboardData()" class="mt-3 px-4 py-2 text-sm bg-indigo-900/30 text-indigo-400 rounded-lg hover:bg-indigo-900/50">
                <i class="fas fa-sync-alt mr-2"></i>Try Again
            </button>
        </div>
    `;
}

async function refreshRecentAttendance() {
    const recentContainer = document.getElementById('recentAttendanceContainer');
    if (!recentContainer) return;
    
    // Show loading
    recentContainer.innerHTML = `
        <div class="p-8 text-center text-gray-400">
            <div class="flex items-center justify-center space-x-2">
                <div class="loading-spinner"></div>
                <span>Refreshing...</span>
            </div>
        </div>
    `;
    
    try {
        await loadRecentAttendanceDirectly();
        showToast('Recent attendance refreshed', 'success');
    } catch (error) {
        console.error('Error refreshing recent attendance:', error);
        showFallbackRecentAttendance();
        showToast('Error refreshing attendance', 'error');
    }
}

function updateDashboardUI(data) {
    if (!data) return;
    
    // Safely update all elements with null checks
    try {
        // Update overall attendance
        const overallPercent = data.overall_stats?.attendance_percent || 0;
        const overallElement = document.getElementById('overallAttendancePercent');
        if (overallElement) {
            overallElement.textContent = overallPercent.toFixed(1) + '%';
        }
        
        // Update monthly stats
        const monthStats = data.monthly_stats || {};
        const presentDays = monthStats.present_days || 0;
        const workingDays = monthStats.working_days || 0;
        const absentDays = monthStats.absent_days || 0;
        
        const presentElement = document.getElementById('monthPresentDays');
        if (presentElement) presentElement.textContent = presentDays;
        
        const workingElement = document.getElementById('monthWorkingDays');
        if (workingElement) workingElement.textContent = workingDays;
        
        const absentElement = document.getElementById('monthAbsentDays');
        if (absentElement) absentElement.textContent = absentDays;
        
        document.getElementById('monthLeavesUsed').textContent = monthStats.leaves_used || 0;
        
        // Update attendance status text
        updateAttendanceStatusText(overallPercent);
        
        // Update progress bars if they exist
        updateProgressBars(presentDays, absentDays, workingDays);
        
        // Update chart with weekly trend
        if (data.weekly_trend) {
            updateAttendanceTrendChart(data.weekly_trend);
        }
        
        // Update recent attendance
        if (data.recent_attendance) {
            // Make sure we have an array
            const recentAttendance = Array.isArray(data.recent_attendance) ? 
                data.recent_attendance : [];
            
            // Filter out any null/undefined items
            const validAttendance = recentAttendance.filter(item => 
                item && (item.status || item.date)
            );
            
            updateRecentAttendance(validAttendance);
        } else {
            // If no recent attendance data, show empty state
            updateRecentAttendance([]);
        }
        
    } catch (error) {
        console.error('Error updating dashboard UI:', error);
    }
}

function initializeRecentAttendance() {
    const recentContainer = document.getElementById('recentAttendanceContainer');
    if (!recentContainer) return;
    
    // Check if we have cached data first
    const cachedData = localStorage.getItem('dashboard_data');
    if (cachedData) {
        try {
            const data = JSON.parse(cachedData);
            if (data.recent_attendance && data.recent_attendance.length > 0) {
                // Show cached data while loading fresh data
                updateRecentAttendance(data.recent_attendance);
                return;
            }
        } catch (error) {
            console.error('Error parsing cached data:', error);
        }
    }
    
    // If no cached data, show loading state
    recentContainer.innerHTML = `
        <div class="p-8 text-center text-gray-400">
            <div class="flex items-center justify-center space-x-2">
                <div class="loading-spinner"></div>
                <span>Loading recent attendance...</span>
            </div>
        </div>
    `;
}

function updateUserInfo(studentInfo) {
    // Update user information display
    if (!studentInfo) return;
    
    try {
        // Update name elements
        const nameElements = [
            document.getElementById('studentName'),
            document.getElementById('dropdownStudentName'),
            document.getElementById('profileDisplayName'),
            document.getElementById('profileName')
        ];
        
        nameElements.forEach(el => {
            if (el && studentInfo.full_name) {
                el.textContent = studentInfo.full_name;
                if (el.id === 'profileName') {
                    el.value = studentInfo.full_name;
                }
            }
        });
        
        // Update email elements
        const emailElements = [
            document.getElementById('dropdownStudentEmail'),
            document.getElementById('profileEmail'),
            document.getElementById('profileDisplayEmail')
        ];
        
        emailElements.forEach(el => {
            if (el && studentInfo.email) {
                el.textContent = studentInfo.email;
                if (el.id === 'profileEmail') {
                    el.value = studentInfo.email;
                }
            }
        });
        
        // Update roll number
        const profileRollNo = document.getElementById('profileRollNo');
        if (profileRollNo && studentInfo.roll_no) {
            profileRollNo.textContent = studentInfo.roll_no;
        }
        
        // Update class and stream
        const profileClassStream = document.getElementById('profileClassStream');
        if (profileClassStream) {
            let classStreamText = '';
            if (studentInfo.standard) {
                classStreamText = studentInfo.standard;
                if (studentInfo.stream) {
                    classStreamText += ` - ${studentInfo.stream}`;
                }
            } else {
                classStreamText = 'Grade 10 - Science';
            }
            profileClassStream.textContent = classStreamText;
        }
        
        // Update section subtitle
        const sectionSubtitle = document.getElementById('sectionSubtitle');
        if (sectionSubtitle && studentInfo.full_name) {
            sectionSubtitle.textContent = `Welcome back, ${studentInfo.full_name}`;
        }
        
        // Update student class info
        const studentClassElement = document.getElementById('studentClass');
        if (studentClassElement) {
            if (studentInfo.standard && studentInfo.stream) {
                studentClassElement.textContent = `Class: ${studentInfo.standard} - ${studentInfo.stream}`;
            } else if (studentInfo.standard) {
                studentClassElement.textContent = `Class: ${studentInfo.standard}`;
            }
        }
        
        // Store in localStorage for offline use
        if (studentInfo.full_name) {
            localStorage.setItem('student_name', studentInfo.full_name);
        }
        if (studentInfo.email) {
            localStorage.setItem('user_email', studentInfo.email);
        }
        if (studentInfo.roll_no) {
            localStorage.setItem('student_roll_no', studentInfo.roll_no);
        }
        if (studentInfo.standard) {
            localStorage.setItem('student_class', studentInfo.standard);
        }
        if (studentInfo.stream) {
            localStorage.setItem('student_stream', studentInfo.stream);
        }
        
    } catch (error) {
        console.error('Error updating user info:', error);
    }
}

function updateAttendanceStatusText(percent) {
    const attendanceStatusText = document.getElementById('attendanceStatusText');
    if (!attendanceStatusText) return;
    
    if (percent >= 90) {
        attendanceStatusText.innerHTML = '<i class="fas fa-calendar-check mr-1"></i>Excellent';
        attendanceStatusText.className = 'text-green-400 text-sm';
    } else if (percent >= 75) {
        attendanceStatusText.innerHTML = '<i class="fas fa-calendar-check mr-1"></i>Good';
        attendanceStatusText.className = 'text-yellow-400 text-sm';
    } else if (percent >= 60) {
        attendanceStatusText.innerHTML = '<i class="fas fa-calendar-alt mr-1"></i>Fair';
        attendanceStatusText.className = 'text-yellow-400 text-sm';
    } else {
        attendanceStatusText.innerHTML = '<i class="fas fa-calendar-times mr-1"></i>Needs Improvement';
        attendanceStatusText.className = 'text-red-400 text-sm';
    }
}

function updateProgressBars(presentDays, absentDays, workingDays) {
    // Update the attendance summary section
    const presentPercent = workingDays > 0 ? (presentDays / workingDays * 100) : 0;
    const absentPercent = workingDays > 0 ? (absentDays / workingDays * 100) : 0;
    
    // Update present progress bar
    const presentProgress = document.querySelector('.progress-fill[style*="width: 81%"]');
    if (presentProgress) {
        presentProgress.style.width = presentPercent.toFixed(1) + '%';
    }
    
    // Update absent progress bar
    const absentProgress = document.querySelector('.progress-fill.bg-red-500');
    if (absentProgress) {
        absentProgress.style.width = absentPercent.toFixed(1) + '%';
    }
    
    // Update the text values in attendance summary
    const presentText = document.querySelector('#dashboardTab .glass-card .space-y-4 div:first-child span:last-child');
    if (presentText && presentText.classList.contains('text-green-400')) {
        presentText.textContent = presentDays;
    }
    
    const absentText = document.querySelector('#dashboardTab .glass-card .space-y-4 div:nth-child(2) span:last-child');
    if (absentText && absentText.classList.contains('text-red-400')) {
        absentText.textContent = absentDays;
    }
}

function updateRecentAttendance(recentAttendance) {
    // Update the recent attendance section in dashboard
    const recentContainer = document.getElementById('recentAttendanceContainer');
    
    if (!recentContainer) {
        console.error('Recent attendance container not found');
        return;
    }
    
    // Clear the container completely
    recentContainer.innerHTML = '';
    
    // Check if we have valid data
    if (!recentAttendance || recentAttendance.length === 0) {
        showFallbackRecentAttendance();
        return;
    }
    
    // Show recent attendance items (max 4)
    const itemsToShow = Math.min(recentAttendance.length, 4);
    let hasValidItems = false;
    
    for (let i = 0; i < itemsToShow; i++) {
        const attendance = recentAttendance[i];
        
        // Skip invalid items
        if (!attendance || (!attendance.status && !attendance.date)) {
            continue;
        }
        
        hasValidItems = true;
        
        // Only show Present or Absent status
        let status = attendance.status;
        let statusClass = '';
        let bgClass = '';
        
        // Convert status to only Present or Absent
        if (status === 'PRESENT' || status === 'PRESENT_FULL_DAY' || 
            status === 'LATE' || status === 'HALF_DAY') {
            status = 'Present';
            statusClass = 'badge-success';
            bgClass = 'bg-green-900/20';
        } else if (status === 'ABSENT' || status === 'LEAVE') {
            status = 'Absent';
            statusClass = 'badge-danger';
            bgClass = 'bg-red-900/20';
        } else {
            // Default to Present for unknown status
            status = 'Present';
            statusClass = 'badge-success';
            bgClass = 'bg-green-900/20';
        }
        
        // Format date nicely
        let displayDate = '';
        if (attendance.formatted_date) {
            displayDate = attendance.formatted_date;
        } else if (attendance.date) {
            try {
                const dateObj = new Date(attendance.date);
                if (!isNaN(dateObj.getTime())) {
                    displayDate = dateObj.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                } else {
                    displayDate = 'Invalid date';
                }
            } catch (error) {
                displayDate = 'Invalid date';
            }
        } else {
            displayDate = 'Unknown date';
        }
        
        // Get day name
        let dayName = attendance.day_name || '';
        if (!dayName && attendance.date) {
            try {
                const dateObj = new Date(attendance.date);
                if (!isNaN(dateObj.getTime())) {
                    dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                }
            } catch (error) {
                // Leave dayName empty if date parsing fails
            }
        }
        
        // Create the attendance item
        const item = document.createElement('div');
        item.className = `flex items-center justify-between p-3 rounded-lg ${bgClass}`;
        
        item.innerHTML = `
            <div>
                <p class="font-medium">${dayName}</p>
                <p class="text-xs text-gray-400">${displayDate}</p>
                ${attendance.time_in && attendance.time_in !== '--' && attendance.time_in !== 'N/A' ? 
                    `<p class="text-xs text-gray-400 mt-1">Time: ${attendance.time_in}</p>` : ''}
            </div>
            <span class="badge ${statusClass}">${status}</span>
        `;
        
        recentContainer.appendChild(item);
    }
    
    // If no valid items were found, show fallback
    if (!hasValidItems) {
        showFallbackRecentAttendance();
        return;
    }
    
    // If we have more than 4 records, add a view all link
    if (recentAttendance.length > 4) {
        const viewAllLink = document.createElement('div');
        viewAllLink.className = 'text-center pt-3 border-t border-gray-800';
        viewAllLink.innerHTML = `
            <button onclick="setActiveTab('attendanceRecords')" 
                    class="text-indigo-400 hover:text-indigo-300 text-sm flex items-center justify-center space-x-1 w-full">
                <span>View All Records</span>
                <i class="fas fa-chevron-right text-xs"></i>
            </button>
        `;
        recentContainer.appendChild(viewAllLink);
    }
}

function updateSidebarStats(data) {
    const sidebarStats = data.sidebar_stats || data.monthly_stats || {};
    
    const presentDays = sidebarStats.present_days || 0;
    const absentDays = sidebarStats.absent_days || 0;
    const attendancePercent = sidebarStats.attendance_percent || 0;
    const workingDays = sidebarStats.working_days || 0;
    
    // Calculate leaves left (assuming 2 leaves per month)
    const leavesUsed = data.monthly_stats?.leaves_used || 0;
    const leavesLeft = Math.max(0, 2 - leavesUsed);
    
    document.getElementById('sidebarPresentDays').textContent = presentDays;
    document.getElementById('sidebarAbsentDays').textContent = absentDays;
    document.getElementById('sidebarAttendancePercent').textContent = attendancePercent.toFixed(1) + '%';
    document.getElementById('sidebarLeavesLeft').textContent = leavesLeft;
}

// ==================== CHART FUNCTIONS ====================
function loadAttendanceTrendChart() {
    const ctx = document.getElementById('attendanceTrendChart')?.getContext('2d');
    if (!ctx) return;
    
    if (charts.attendanceTrend) {
        charts.attendanceTrend.destroy();
    }
    
    const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#334155';
    const gridColor = currentTheme === 'dark' ? '#334155' : '#e2e8f0';
    
    // Initial chart - will be updated with real data
    charts.attendanceTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Loading...'],
            datasets: [{
                label: 'Attendance %',
                data: [0],
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#6366f1',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: textColor,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
                    titleColor: textColor,
                    bodyColor: textColor,
                    borderColor: '#6366f1',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textColor,
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    min: 0,
                    max: 100,
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textColor,
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function updateAttendanceTrendChart(weeklyData) {
    const ctx = document.getElementById('attendanceTrendChart')?.getContext('2d');
    if (!ctx || !charts.attendanceTrend) return;
    
    // Update chart with real data
    const labels = weeklyData.map(week => week.week);
    const dataPoints = weeklyData.map(week => week.attendance_percent);
    
    charts.attendanceTrend.data.labels = labels;
    charts.attendanceTrend.data.datasets[0].data = dataPoints;
    charts.attendanceTrend.update();
}

function loadCurrentMonthTrend() {
    showToast('Loading current month trend...', 'info');
    // Refresh dashboard data
    loadDashboardData();
}

function loadLastMonthTrend() {
    showToast('Loading last month trend...', 'info');
    // This would call a specific API for last month data
    // For now, just refresh dashboard
    loadDashboardData();
}

function loadQuarterTrend() {
    showToast('Loading 3-month trend...', 'info');
    // This would call a specific API for quarter data
    // For now, just refresh dashboard
    loadDashboardData();
}

// ==================== CALENDAR FUNCTIONS ====================
async function generateCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth(); // JavaScript months are 0-indexed
    
    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    
    // Use month+1 for API call (since API expects 1-indexed months)
    try {
        // Fetch calendar data from API
        const response = await fetch(`${API_BASE_URL}/attendance/calendar/${year}/${month + 1}`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                renderCalendar(result.data);
                return;
            }
        }
        
        // If API fails, show fallback calendar
        showFallbackCalendar(year, month + 1);
        
    } catch (error) {
        console.error('Error loading calendar data:', error);
        showFallbackCalendar(year, month + 1);
    }
}

function showFallbackCalendar(year, month) {
    const calendarDays = document.getElementById('calendarDays');
    if (!calendarDays) return;
    
    calendarDays.innerHTML = '';
    
    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();
    const today = new Date();
    
    // Update the calendar title in fallback too
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = `${monthNames[month - 1]} ${year}`;
    
    // Add empty cells
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day opacity-30';
        calendarDays.appendChild(emptyDay);
    }
    
    // Add days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day;
        
        const date = new Date(year, month - 1, day);
        
        // Check if today
        if (date.getDate() === today.getDate() && 
            date.getMonth() === today.getMonth() && 
            date.getFullYear() === today.getFullYear()) {
            dayElement.classList.add('today');
        }
        
        // Mark weekends
        if (date.getDay() === 0 || date.getDay() === 6) {
            dayElement.classList.add('opacity-50');
            dayElement.title = 'Weekend';
        }
        
        calendarDays.appendChild(dayElement);
    }
}

function renderCalendar(calendarData) {
    const calendarDays = document.getElementById('calendarDays');
    if (!calendarDays) return;
    
    calendarDays.innerHTML = '';
    
    // Add empty cells for days before the first day of month
    const firstDay = new Date(calendarData.year, calendarData.month - 1, 1).getDay();
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarDays.appendChild(emptyDay);
    }
    
    // Add days of the month
    calendarData.calendar_data.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day.day;
        
        // Add classes based on status
        if (day.is_today) {
            dayElement.classList.add('today');
        }
        
        if (day.status === 'PRESENT' && !day.is_weekend) {
            dayElement.classList.add('present');
        } else if (day.status === 'ABSENT' && !day.is_weekend && day.is_working_day) {
            dayElement.classList.add('absent');
        }
        
        // Add title with time info if present
        if (day.status === 'PRESENT' && day.time_in) {
            dayElement.title = `Present - Checked in at ${day.time_in}`;
        } else if (day.is_weekend) {
            dayElement.title = 'Weekend';
            dayElement.classList.add('opacity-50');
        }
        
        calendarDays.appendChild(dayElement);
    });
}

function prevMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    // Don't allow going to future months beyond current month
    const now = new Date();
    const nextMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1);
    if (nextMonth > now) {
        // If next month would be in the future, reset to current month
        currentCalendarDate = new Date();
        showToast('Cannot view future months', 'info');
    }
    generateCalendar();
}

// ==================== ATTENDANCE RECORDS ====================
async function loadAttendanceRecords() {
    showLoading('Loading attendance records...');
    
    try {
        // Get filter values
        const monthFilter = document.getElementById('filterMonth').value;
        const yearFilter = document.getElementById('filterYear').value;
        
        // Build API URL with filters
        let apiUrl = `${API_BASE_URL}/attendance/records`;
        const params = new URLSearchParams();
        
        if (monthFilter && monthFilter !== 'all') {
            params.append('month', monthFilter);
        }
        if (yearFilter && yearFilter !== 'all') {
            params.append('year', yearFilter);
        }
        
        if (params.toString()) {
            apiUrl += `?${params.toString()}`;
        }
        
        const response = await fetch(apiUrl, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            allAttendanceRecords = result.data.records;
            updateAttendanceRecordsStats(result.data);
            renderAttendanceRecordsTable();
        } else {
            throw new Error(result.message || 'Failed to load attendance records');
        }
        
    } catch (error) {
        console.error('Error loading attendance records:', error);
        showToast('Error loading attendance records', 'error');
        
        // Fallback: Load data without filters if API fails
        loadAttendanceRecordsFallback();
    } finally {
        hideLoading();
    }
}

async function loadAttendanceRecordsFallback() {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    
    // Set default filters
    document.getElementById('filterMonth').value = currentMonth;
    document.getElementById('filterYear').value = currentYear;
    
    // Show fallback data
    showFallbackAttendanceData();
}

function showFallbackAttendanceData() {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    
    // Create fallback data for demonstration
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    // Generate some sample records for current month
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    const fallbackRecords = [];
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth - 1, day);
        // Skip weekends for sample data
        if (date.getDay() !== 0 && date.getDay() !== 6) {
            const isPresent = Math.random() > 0.2; // 80% chance of being present
            const status = isPresent ? 'PRESENT' : 'ABSENT';
            
            fallbackRecords.push({
                id: day,
                date: date.toISOString().split('T')[0],
                formatted_date: date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                day_name: date.toLocaleDateString('en-US', { weekday: 'long' }),
                status: status,
                time_in: isPresent ? '09:' + (Math.floor(Math.random() * 60)).toString().padStart(2, '0') + ' AM' : '--',
                recorded_by: 'System',
                remarks: isPresent ? 'Regular attendance' : 'No attendance recorded',
                is_working_day: true
            });
        }
    }
    
    allAttendanceRecords = fallbackRecords.reverse(); // Show newest first
    updateFallbackStats();
    renderAttendanceRecordsTable();
}

function updateFallbackStats() {
    const total = allAttendanceRecords.length;
    const present = allAttendanceRecords.filter(r => r.status === 'PRESENT').length;
    const attendancePercent = total > 0 ? Math.round((present / total) * 100) : 0;
    
    document.getElementById('recordsTotalDays').textContent = total;
    document.getElementById('recordsPresentDays').textContent = present;
    document.getElementById('recordsAbsentDays').textContent = total - present;
    document.getElementById('recordsAttendancePercent').textContent = attendancePercent + '%';
}

function updateAttendanceRecordsStats(data) {
    const present = allAttendanceRecords.filter(r => r.status === 'PRESENT').length;
    const total = allAttendanceRecords.length;
    const attendancePercent = total > 0 ? Math.round((present / total) * 100) : 0;
    
    document.getElementById('recordsTotalDays').textContent = total;
    document.getElementById('recordsPresentDays').textContent = present;
    document.getElementById('recordsAbsentDays').textContent = total - present;
    document.getElementById('recordsAttendancePercent').textContent = attendancePercent + '%';
}

function renderAttendanceRecordsTable() {
    const tableBody = document.getElementById('attendanceRecordsTableBody');
    if (!tableBody) return;
    
    // Remove loading row
    const loadingRow = document.getElementById('attendanceRecordsLoadingRow');
    if (loadingRow) loadingRow.remove();
    
    // Get filtered records
    const filteredRecords = filterAttendanceRecordsList(allAttendanceRecords);
    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
    const startIndex = (currentRecordsPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const pageRecords = filteredRecords.slice(startIndex, endIndex);
    
    tableBody.innerHTML = '';
    
    if (pageRecords.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="p-8 text-center text-gray-400">
                    <i class="fas fa-calendar-alt text-3xl mb-3"></i>
                    <p class="text-lg">No attendance records found</p>
                    <p class="text-sm mt-1">Try adjusting your filters</p>
                </td>
            </tr>
        `;
    } else {
        pageRecords.forEach(record => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-800 hover:bg-gray-800/50';
            
            let statusBadge = '';
            let statusColor = '';
            if (record.status === 'PRESENT') {
                statusBadge = 'Present';
                statusColor = 'badge-success';
            } else if (record.status === 'ABSENT') {
                statusBadge = 'Absent';
                statusColor = 'badge-danger';
            } else if (record.status === 'LATE') {
                statusBadge = 'Late';
                statusColor = 'badge-warning';
            } else if (record.status === 'HALF_DAY') {
                statusBadge = 'Half Day';
                statusColor = 'badge-info';
            } else if (record.status === 'LEAVE') {
                statusBadge = 'Leave';
                statusColor = 'badge-purple';
            }
            
            row.innerHTML = `
                <td class="p-4">${record.formatted_date}</td>
                <td class="p-4">${record.day_name}</td>
                <td class="p-4">
                    <span class="badge ${statusColor}">${statusBadge}</span>
                </td>
                <td class="p-4">${record.time_in}</td>
                <td class="p-4 text-gray-400">${record.remarks || '-'}</td>
                <td class="p-4 text-gray-400">${record.recorded_by}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Update table info and pagination
    document.getElementById('attendanceRecordsTableInfo').textContent = 
        `Showing ${startIndex + 1}-${Math.min(endIndex, filteredRecords.length)} of ${filteredRecords.length} records`;
    
    updatePagination('attendanceRecordsPagination', currentRecordsPage, totalPages, 'changeRecordsPage');
}

function filterAttendanceRecordsList(records) {
    const monthFilter = document.getElementById('filterMonth').value;
    const yearFilter = document.getElementById('filterYear').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const searchTerm = document.getElementById('searchAttendance').value.toLowerCase();
    
    return records.filter(record => {
        const recordDate = new Date(record.date);
        const recordMonth = recordDate.getMonth() + 1; // JavaScript months are 0-indexed
        const recordYear = recordDate.getFullYear();
        
        // Filter by month
        if (monthFilter !== 'all' && String(recordMonth) !== monthFilter) {
            return false;
        }
        
        // Filter by year
        if (yearFilter !== 'all' && String(recordYear) !== yearFilter) {
            return false;
        }
        
        // Filter by status
        if (statusFilter !== 'all' && record.status !== statusFilter) {
            return false;
        }
        
        // Filter by search term
        if (searchTerm && !record.formatted_date.toLowerCase().includes(searchTerm) &&
            !record.day_name.toLowerCase().includes(searchTerm) &&
            !record.remarks.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        return true;
    });
}

async function filterAttendanceRecords() {
    showLoading('Filtering attendance records...');
    
    try {
        // Get current filter values
        const monthFilter = document.getElementById('filterMonth').value;
        const yearFilter = document.getElementById('filterYear').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const searchTerm = document.getElementById('searchAttendance').value.toLowerCase();
        
        // If "all" is selected for month/year, we need to call a different API endpoint
        // or handle filtering locally
        if (monthFilter === 'all' || yearFilter === 'all') {
            // Load all records and filter locally
            await loadAllAttendanceRecords();
        } else {
            // Call API with specific month/year
            const response = await fetch(`${API_BASE_URL}/attendance/records?month=${monthFilter}&year=${yearFilter}`, {
                headers: getHeaders()
            });
            
            if (checkTokenExpired(response)) {
                hideLoading();
                return;
            }
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                allAttendanceRecords = result.data.records;
                updateAttendanceRecordsStats(result.data);
            } else {
                throw new Error(result.message || 'Failed to load filtered records');
            }
        }
        
        // Apply local filters (status and search)
        currentRecordsPage = 1;
        renderAttendanceRecordsTable();
        
    } catch (error) {
        console.error('Error filtering records:', error);
        showToast('Error filtering records', 'error');
    } finally {
        hideLoading();
    }
}

async function loadAllAttendanceRecords() {
    try {
        const response = await fetch(`${API_BASE_URL}/attendance/records`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            throw new Error('Token expired');
        }
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            allAttendanceRecords = result.data.records;
        } else {
            throw new Error(result.message || 'Failed to load all records');
        }
    } catch (error) {
        console.error('Error loading all records:', error);
        throw error;
    }
}

function changeRecordsPage(page) {
    currentRecordsPage = page;
    renderAttendanceRecordsTable();
}

// ==================== LEAVE REQUEST FUNCTIONS ====================
async function loadLeaveRequests() {
    try {
        const response = await fetch(`${API_BASE_URL}/leave-requests`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                leaveRequests = result.data;
                updateLeaveStats();
                renderLeaveHistoryTable();
            }
        } else {
            showToast('This feature is coming soon', 'error');
        }
    } catch (error) {
        console.error('Error loading leave requests:', error);
        showToast('Error loading leave requests', 'error');
    }
}

function updateLeaveStats() {
    // These would come from API
    const totalLeaves = 12; // Annual leaves allocated
    const leavesUsed = leaveRequests.filter(r => r.status === 'APPROVED').length;
    const leavesLeft = Math.max(0, totalLeaves - leavesUsed);
    const pendingRequests = leaveRequests.filter(r => r.status === 'PENDING').length;
    
    document.getElementById('totalLeaves').textContent = totalLeaves;
    document.getElementById('leavesUsed').textContent = leavesUsed;
    document.getElementById('leavesLeft').textContent = leavesLeft;
    document.getElementById('pendingRequests').textContent = pendingRequests;
}

function renderLeaveHistoryTable() {
    const tableBody = document.getElementById('leaveHistoryTableBody');
    if (!tableBody) return;
    
    if (!leaveRequests || leaveRequests.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="p-8 text-center text-gray-400">
                    <i class="fas fa-envelope text-3xl mb-3"></i>
                    <p class="text-lg">No leave requests found</p>
                    <p class="text-sm mt-1">Submit your first leave request using the form above</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = '';
    
    leaveRequests.forEach(request => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-800 hover:bg-gray-800/50';
        
        let statusBadge = '';
        let statusColor = '';
        
        switch(request.status) {
            case 'PENDING':
                statusBadge = 'Pending';
                statusColor = 'badge-warning';
                break;
            case 'APPROVED':
                statusBadge = 'Approved';
                statusColor = 'badge-success';
                break;
            case 'REJECTED':
                statusBadge = 'Rejected';
                statusColor = 'badge-danger';
                break;
            default:
                statusBadge = request.status;
                statusColor = 'badge-info';
        }
        
        // Format dates
        const appliedDate = new Date(request.applied_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        let leaveDates = '';
        if (request.start_date && request.end_date) {
            const startDate = new Date(request.start_date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            const endDate = new Date(request.end_date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            leaveDates = `${startDate} - ${endDate}`;
        } else if (request.leave_date) {
            const leaveDate = new Date(request.leave_date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            leaveDates = leaveDate + (request.half_day_type ? ` (${request.half_day_type})` : '');
        }
        
        row.innerHTML = `
            <td class="p-4">${appliedDate}</td>
            <td class="p-4">${leaveDates}</td>
            <td class="p-4">${request.type}</td>
            <td class="p-4 text-gray-400">${request.reason.substring(0, 50)}${request.reason.length > 50 ? '...' : ''}</td>
            <td class="p-4">
                <span class="badge ${statusColor}">${statusBadge}</span>
            </td>
            <td class="p-4">
                <div class="flex space-x-2">
                    <button onclick="viewLeaveRequest(${request.id})" 
                            class="px-3 py-1 rounded-lg border border-blue-500 text-blue-400 hover:bg-blue-900/30 text-sm">
                        <i class="fas fa-eye mr-1"></i> View
                    </button>
                    ${request.status === 'PENDING' ? `
                    <button onclick="cancelLeaveRequest(${request.id})" 
                            class="px-3 py-1 rounded-lg border border-red-500 text-red-400 hover:bg-red-900/30 text-sm">
                        <i class="fas fa-times mr-1"></i> Cancel
                    </button>
                    ` : ''}
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function toggleLeaveDuration() {
    const duration = document.getElementById('leaveDuration').value;
    
    // Hide all fields first
    document.getElementById('singleDateField').classList.add('hidden');
    document.getElementById('startDateField').classList.add('hidden');
    document.getElementById('endDateField').classList.add('hidden');
    document.getElementById('halfDayField').classList.add('hidden');
    
    // Show relevant fields
    if (duration === 'SINGLE') {
        document.getElementById('singleDateField').classList.remove('hidden');
    } else if (duration === 'MULTIPLE') {
        document.getElementById('startDateField').classList.remove('hidden');
        document.getElementById('endDateField').classList.remove('hidden');
    } else if (duration === 'HALF') {
        document.getElementById('singleDateField').classList.remove('hidden');
        document.getElementById('halfDayField').classList.remove('hidden');
    }
}

function openNewLeaveModal() {
    // Scroll to the form
    document.getElementById('leaveRequestForm').scrollIntoView({ behavior: 'smooth' });
    
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    document.getElementById('leaveSingleDate').value = tomorrowStr;
    document.getElementById('leaveStartDate').value = tomorrowStr;
    
    // Set end date to tomorrow for multiple days
    document.getElementById('leaveEndDate').value = tomorrowStr;
    
    showToast('Fill in the form to submit a leave request', 'info');
}

function resetLeaveForm() {
    document.getElementById('newLeaveForm').reset();
    toggleLeaveDuration();
}

async function submitLeaveRequest() {
    const leaveType = document.getElementById('leaveType').value;
    const leaveDuration = document.getElementById('leaveDuration').value;
    const leaveReason = document.getElementById('leaveReason').value;
    
    // Get dates based on duration
    let leaveDate, startDate, endDate, halfDayType;
    
    if (leaveDuration === 'SINGLE') {
        leaveDate = document.getElementById('leaveSingleDate').value;
    } else if (leaveDuration === 'MULTIPLE') {
        startDate = document.getElementById('leaveStartDate').value;
        endDate = document.getElementById('leaveEndDate').value;
    } else if (leaveDuration === 'HALF') {
        leaveDate = document.getElementById('leaveSingleDate').value;
        halfDayType = document.getElementById('leaveHalfDay').value;
    }
    
    // Validation
    if (!leaveType || !leaveReason) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    if (leaveDuration === 'SINGLE' && !leaveDate) {
        showToast('Please select a date', 'error');
        return;
    }
    
    if (leaveDuration === 'MULTIPLE' && (!startDate || !endDate)) {
        showToast('Please select both start and end dates', 'error');
        return;
    }
    
    if (leaveDuration === 'HALF' && (!leaveDate || !halfDayType)) {
        showToast('Please select a date and half day type', 'error');
        return;
    }
    
    const leaveData = {
        type: leaveType,
        duration: leaveDuration,
        reason: leaveReason
    };
    
    if (leaveDate) leaveData.leave_date = leaveDate;
    if (startDate) leaveData.start_date = startDate;
    if (endDate) leaveData.end_date = endDate;
    if (halfDayType) leaveData.half_day_type = halfDayType;
    
    showLoading('Submitting leave request...');
    
    try {
        const response = await fetch(`${API_BASE_URL}/leave-requests`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify(leaveData)
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Leave request submitted successfully!', 'success');
                resetLeaveForm();
                loadLeaveRequests(); // Refresh leave requests
            } else {
                showToast(result.message || 'Failed to submit leave request', 'error');
            }
        } else {
            const errorData = await response.json();
            showToast(errorData.detail || 'Failed to submit leave request', 'error');
        }
    } catch (error) {
        console.error('Error submitting leave request:', error);
        showToast('Error submitting leave request', 'error');
    } finally {
        hideLoading();
    }
}

async function viewLeaveRequest(requestId) {
    try {
        const response = await fetch(`${API_BASE_URL}/leave-requests/${requestId}`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                const request = result.data;
                
                // Show modal with request details
                alert(`Leave Request Details:\n\nType: ${request.type}\nStatus: ${request.status}\nDates: ${request.leave_date || `${request.start_date} to ${request.end_date}`}\nReason: ${request.reason}\nApplied on: ${new Date(request.applied_at).toLocaleDateString()}`);
            }
        }
    } catch (error) {
        console.error('Error viewing leave request:', error);
        showToast('Error viewing leave request', 'error');
    }
}

async function cancelLeaveRequest(requestId) {
    if (!confirm('Are you sure you want to cancel this leave request?')) {
        return;
    }
    
    showLoading('Cancelling leave request...');
    
    try {
        const response = await fetch(`${API_BASE_URL}/leave-requests/${requestId}/cancel`, {
            method: 'POST',
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Leave request cancelled successfully!', 'success');
                loadLeaveRequests(); // Refresh leave requests
            } else {
                showToast(result.message || 'Failed to cancel leave request', 'error');
            }
        } else {
            const errorData = await response.json();
            showToast(errorData.detail || 'Failed to cancel leave request', 'error');
        }
    } catch (error) {
        console.error('Error cancelling leave request:', error);
        showToast('Error cancelling leave request', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== PROFILE MANAGEMENT ====================
function initProfileSection() {
    loadProfileData();
    
    // Setup password strength checker
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', (e) => {
            updatePasswordStrength(e.target.value);
            checkPasswordMatch();
        });
    }
    
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    }
}

async function loadProfileData() {
    showLoading('Loading profile...');
    
    try {
        // Load profile from API
        const response = await fetch(`http://localhost:8000/users/profile`, {
            headers: getHeaders()
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                updateProfileDisplay(data.data);
            } else {
                useStoredProfileData();
            }
        } else {
            useStoredProfileData();
        }
    } catch (error) {
        console.error('Error loading profile:', error);
        useStoredProfileData();
    } finally {
        hideLoading();
    }
    
    // Update theme display
    const profileTheme = document.getElementById('profileTheme');
    if (profileTheme) {
        profileTheme.textContent = currentTheme === 'dark' ? 'Dark' : 'Light';
    }
}

function updateProfileDisplay(profileData) {
    // Update name and email
    const displayName = profileData.full_name || profileData.email?.split('@')[0] || 'Student';
    const email = profileData.email || 'student@neuroface.ai';
    
    updateNameDisplay(displayName);
    updateEmailDisplay(email);
    
    // Populate profile form
    populateProfileForm(displayName, email);
    
    // Update academic information in profile section
    updateAcademicInfoInProfile(profileData);
    
    // Also update academic info in other sections if they're visible
    updateAcademicInfoEverywhere(profileData);
}

function updateAcademicInfoInProfile(profileData) {
    // Update roll number in profile section
    const profileRollNo = document.getElementById('profileRollNo');
    if (profileRollNo && profileData.roll_no) {
        profileRollNo.textContent = profileData.roll_no;
    }
    
    // Update class & stream in profile section
    const profileClassStream = document.getElementById('profileClassStream');
    if (profileClassStream) {
        let classStreamText = '';
        if (profileData.class) {
            classStreamText = profileData.class;
            if (profileData.stream) {
                classStreamText += ` - ${profileData.stream}`;
            }
        } else {
            classStreamText = 'Grade 10 - Science';
        }
        profileClassStream.textContent = classStreamText;
    }
    
    // Update profile role badge
    const profileRoleBadge = document.getElementById('profileRoleBadge');
    if (profileRoleBadge && profileData.role) {
        profileRoleBadge.textContent = profileData.role;
        
        // Style based on role
        if (profileData.role === 'STUDENT') {
            profileRoleBadge.className = 'mt-2 px-3 py-1 rounded-full text-xs bg-indigo-900/30 text-indigo-400';
        } else if (profileData.role === 'ADMIN') {
            profileRoleBadge.className = 'mt-2 px-3 py-1 rounded-full text-xs bg-purple-900/30 text-purple-400';
        }
    }
}

function updateAcademicInfoEverywhere(profileData) {
    // Update student class in header dropdown
    const studentClassElement = document.getElementById('studentClass');
    if (studentClassElement) {
        if (profileData.class && profileData.stream) {
            studentClassElement.textContent = `Class: ${profileData.class} - ${profileData.stream}`;
        } else if (profileData.class) {
            studentClassElement.textContent = `Class: ${profileData.class}`;
        }
    }
    
    // Update academic info in academic tab
    updateAcademicTabInfo(profileData);
}

function updateAcademicTabInfo(profileData) {
    // Update academic info tab if it exists
    const academicRollNo = document.getElementById('academicRollNo');
    const academicClass = document.getElementById('academicClass');
    const academicStream = document.getElementById('academicStream');
    const academicSection = document.getElementById('academicSection');
    
    if (academicRollNo && profileData.roll_no) {
        academicRollNo.textContent = profileData.roll_no;
    }
    
    if (academicClass && profileData.class) {
        academicClass.textContent = profileData.class;
    }
    
    if (academicStream && profileData.stream) {
        academicStream.textContent = profileData.stream;
    }
}

function useStoredProfileData() {
    // Use stored data from localStorage
    const displayName = localStorage.getItem('student_name') || 'Student';
    const email = localStorage.getItem('user_email') || 'student@neuroface.ai';
    const rollNo = localStorage.getItem('student_roll_no');
    const studentClass = localStorage.getItem('student_class');
    const studentStream = localStorage.getItem('student_stream');
    
    const storedProfileData = {
        full_name: displayName,
        email: email,
        roll_no: rollNo,
        class: studentClass,
        stream: studentStream,
        role: 'STUDENT'
    };
    
    updateProfileDisplay(storedProfileData);
}

function updateNameDisplay(name) {
    const nameElements = [
        document.getElementById('studentName'),
        document.getElementById('dropdownStudentName'),
        document.getElementById('profileDisplayName'),
        document.getElementById('sectionSubtitle'),
        document.getElementById('profileName')
    ];
    
    nameElements.forEach(el => {
        if (el) {
            if (el.id === 'sectionSubtitle') {
                el.textContent = `Welcome back, ${name}`;
            } else {
                el.textContent = name;
            }
        }
    });
}

function updateEmailDisplay(email) {
    const emailElements = [
        document.getElementById('dropdownStudentEmail'),
        document.getElementById('profileEmail'),
        document.getElementById('profileDisplayEmail')
    ];
    
    emailElements.forEach(el => {
        if (el) el.textContent = email;
    });
}

function populateProfileForm(name, email) {
    const profileNameInput = document.getElementById('profileName');
    const profileEmailInput = document.getElementById('profileEmail');
    
    if (profileNameInput) profileNameInput.value = name || '';
    if (profileEmailInput) profileEmailInput.value = email || '';
}

function updateProfileName() {
    const nameInput = document.getElementById('profileName');
    
    if (!nameInput) return;
    
    const newName = nameInput.value.trim();
    
    if (newName) {
        localStorage.setItem('student_name', newName);
        updateNameDisplay(newName);
        showToast('Display name updated successfully!', 'success');
    } else {
        localStorage.removeItem('student_name');
        loadProfileData();
        showToast('Display name removed. Using email-based name.', 'info');
    }
}

async function updateEmail() {
    const emailInput = document.getElementById('profileEmail');
    
    if (!emailInput) return;
    
    const newEmail = emailInput.value.trim();
    
    if (!newEmail || !validateEmail(newEmail)) {
        showToast('Please enter a valid email address', 'error');
        return;
    }
    
    showLoading('Updating email...');
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('http://localhost:8000/users/profile/email', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: newEmail
            })
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            localStorage.setItem('user_email', newEmail);
            updateEmailDisplay(newEmail);
            showToast('Email updated successfully!', 'success');
        } else {
            showToast(result.message || 'Failed to update email', 'error');
        }
    } catch (error) {
        console.error('Error updating email:', error);
        showToast('Error updating email', 'error');
    } finally {
        hideLoading();
    }
}

async function changePassword() {
    const currentPassword = document.getElementById('currentPassword')?.value;
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmPassword')?.value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('Please fill in all password fields', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showToast('New passwords do not match', 'error');
        return;
    }
    
    if (!validatePasswordStrength(newPassword)) {
        showToast('Password does not meet strength requirements', 'error');
        return;
    }
    
    showLoading('Changing password...');
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('http://localhost:8000/users/profile/change-password', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        if (checkTokenExpired(response)) {
            hideLoading();
            return;
        }
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('Password changed successfully!', 'success');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            updatePasswordStrength('');
        } else {
            showToast(result.message || 'Failed to change password', 'error');
        }
    } catch (error) {
        console.error('Error changing password:', error);
        showToast('Error changing password', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== UTILITY FUNCTIONS ====================
function formatDate(date) {
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatTime(dateTime) {
    const date = new Date(dateTime);
    return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

function updatePagination(elementId, currentPage, totalPages, callbackFunction) {
    const paginationContainer = document.getElementById(elementId);
    if (!paginationContainer) return;
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    if (currentPage > 1) {
        html += `<button onclick="${callbackFunction}(${currentPage - 1})" class="px-3 py-1 rounded-lg glass-card hover:bg-gray-800/50">
                    <i class="fas fa-chevron-left"></i>
                </button>`;
    }
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<button class="px-3 py-1 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                        ${i}
                    </button>`;
        } else {
            html += `<button onclick="${callbackFunction}(${i})" class="px-3 py-1 rounded-lg glass-card hover:bg-gray-800/50">
                        ${i}
                    </button>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<button onclick="${callbackFunction}(${currentPage + 1})" class="px-3 py-1 rounded-lg glass-card hover:bg-gray-800/50">
                    <i class="fas fa-chevron-right"></i>
                </button>`;
    }
    
    paginationContainer.innerHTML = html;
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toastIcon');
    const toastMessage = document.getElementById('toastMessage');
    
    let icon = 'fa-info-circle';
    let iconColor = 'text-blue-400';
    
    if (type === 'success') {
        icon = 'fa-check-circle';
        iconColor = 'text-green-400';
    } else if (type === 'error') {
        icon = 'fa-exclamation-circle';
        iconColor = 'text-red-400';
    } else if (type === 'warning') {
        icon = 'fa-exclamation-triangle';
        iconColor = 'text-yellow-400';
    }
    
    toastIcon.className = `fas ${icon} ${iconColor}`;
    toastMessage.textContent = message;
    
    toast.classList.remove('hidden');
    toast.classList.add('success-toast');
    
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

function showLoading(text = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    
    loadingText.textContent = text;
    overlay.classList.remove('hidden');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('hidden');
}

function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    const mobileThemeIcon = document.getElementById('mobileThemeToggle')?.querySelector('i');
    
    if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        body.classList.add('light');
        currentTheme = 'light';
        if (themeIcon) themeIcon.className = 'fas fa-sun';
        if (mobileThemeIcon) mobileThemeIcon.className = 'fas fa-sun';
        localStorage.setItem('theme', 'light');
    } else {
        body.classList.remove('light');
        body.classList.add('dark');
        currentTheme = 'dark';
        if (themeIcon) themeIcon.className = 'fas fa-moon';
        if (mobileThemeIcon) mobileThemeIcon.className = 'fas fa-moon';
        localStorage.setItem('theme', 'dark');
    }
    
    // Update charts if they exist
    if (charts.attendanceTrend) {
        loadAttendanceTrendChart();
    }
    
    // Regenerate calendar with new theme
    generateCalendar();
}

function populateMonthFilter() {
    const monthFilter = document.getElementById('filterMonth');
    if (!monthFilter) return;
    
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    monthFilter.innerHTML = '<option value="all">All Months</option>';
    
    months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index + 1; // JavaScript months are 0-indexed, but our API expects 1-indexed
        option.textContent = month;
        monthFilter.appendChild(option);
    });
    
    // Set current month as default
    const currentMonth = new Date().getMonth() + 1;
    monthFilter.value = currentMonth;
}

// Function to populate year filter dynamically
function populateYearFilter() {
    const yearFilter = document.getElementById('filterYear');
    if (!yearFilter) return;
    
    const currentYear = new Date().getFullYear();
    const startYear = 2025; 
    
    yearFilter.innerHTML = '';
    
    // Add "All Years" option
    const allOption = document.createElement('option');
    allOption.value = 'all';
    allOption.textContent = 'All Years';
    yearFilter.appendChild(allOption);
    
    // Only show current year and previous years (NOT future years)
    for (let year = currentYear; year >= startYear; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    }
    
    // Set current year as default
    yearFilter.value = currentYear;
}

function setActiveTab(tabName) {
    // Hide all tabs
    const tabs = ['dashboardTab', 'attendanceRecordsTab', 'academicInfoTab', 'leaveRequestTab', 'profileSection'];
    tabs.forEach(tab => {
        const element = document.getElementById(tab);
        if (element) {
            element.classList.add('hidden');
        }
    });
    
    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Show selected tab
    const tabElement = document.getElementById(tabName === 'profile' ? 'profileSection' : tabName + 'Tab');
    if (tabElement) {
        tabElement.classList.remove('hidden');
        tabElement.classList.add('fade-in');
    }
    
    // Add active class to clicked nav link
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        if (link.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1)) || 
            (tabName === 'attendanceRecords' && link.textContent.includes('Attendance Records')) ||
            (tabName === 'academicInfo' && link.textContent.includes('Academic Info')) ||
            (tabName === 'leaveRequest' && link.textContent.includes('Leave Request'))) {
            link.classList.add('active');
        }
    });
    
    // Update page title
    const pageTitle = document.getElementById('pageTitle');
    const sectionSubtitle = document.getElementById('sectionSubtitle');
    
    const titles = {
        'dashboard': 'Student Dashboard',
        'attendanceRecords': 'Attendance Records',
        'academicInfo': 'Academic Information',
        'leaveRequest': 'Leave Request',
        'profile': 'My Profile'
    };
    
    const subtitles = {
        'dashboard': 'Overview of your attendance and performance',
        'attendanceRecords': 'View and filter your attendance history',
        'academicInfo': 'Your academic details and performance',
        'leaveRequest': 'Apply for leave and track your requests',
        'profile': 'Manage your account information and security'
    };
    
    if (pageTitle && titles[tabName]) {
        pageTitle.textContent = titles[tabName];
    }
    
    if (sectionSubtitle) {
        if (tabName === 'dashboard') {
            const userName = localStorage.getItem('student_name') || 'Student';
            sectionSubtitle.textContent = `Welcome back, ${userName}`;
        } else {
            sectionSubtitle.textContent = subtitles[tabName] || '';
        }
    }
    
    // Load data based on section
    if (tabName === 'profile') {
        initProfileSection();
    } else if (tabName === 'dashboard') {
        loadDashboardData();
    } else if (tabName === 'attendanceRecords') {
        loadAttendanceRecords();
    } else if (tabName === 'leaveRequest') {
        loadLeaveRequests();
    }
    
    // Close mobile sidebar if open
    const mobileSidebar = document.getElementById('mobileSidebar');
    if (mobileSidebar && !mobileSidebar.classList.contains('hidden')) {
        toggleSidebar();
    }
}

function showSection(sectionId) {
    setActiveTab(sectionId);
}

function toggleSidebar() {
    const sidebar = document.getElementById('mobileSidebar');
    sidebar.classList.toggle('hidden');
}

function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('hidden');
}

function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.add('hidden');
    });
}

function initializeClock() {
    updateClock();
    setInterval(updateClock, 1000);
}

function updateClock() {
    const now = new Date();
    
    // Update current time
    const currentTimeElement = document.getElementById('currentTime');
    if (currentTimeElement) {
        currentTimeElement.textContent = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }
    
    // Update current date
    const currentDateElement = document.getElementById('currentDate');
    if (currentDateElement) {
        currentDateElement.textContent = now.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
}

function setupEventListeners() {
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const userDropdown = document.getElementById('userDropdown');
        const dropdownToggle = document.querySelector('[onclick="toggleUserDropdown()"]');
        
        if (userDropdown && !userDropdown.contains(event.target) && dropdownToggle && !dropdownToggle.contains(event.target)) {
            userDropdown.classList.add('hidden');
        }
    });
    
    // Close modals when clicking outside
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            closeAllModals();
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        // Refresh dashboard with F5
        if (event.key === 'F5') {
            event.preventDefault();
            refreshDashboard();
        }
        
        // Escape key closes modals
        if (event.key === 'Escape') {
            closeAllModals();
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown && !userDropdown.classList.contains('hidden')) {
                userDropdown.classList.add('hidden');
            }
        }
    });
}

function refreshDashboard() {
    if (document.getElementById('dashboardTab').classList.contains('hidden')) {
        setActiveTab('dashboard');
    } else {
        loadDashboardData();
        generateCalendar();
        showToast('Dashboard refreshed', 'info');
    }
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

async function logout() {
    if (!confirm('Are you sure you want to logout?')) {
        return;
    }
    
    showLoading('Logging out...');
    
    try {
        // Simulate API call
        setTimeout(() => {
            // Clear local storage
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_role');
            localStorage.removeItem('institute_id');
            localStorage.removeItem('user_email');
            localStorage.removeItem('student_name');
            
            // Redirect to login page
            window.location.href = '/UI/register.html';
        }, 1000);
        
    } catch (error) {
        console.error('Error logging out:', error);
        // Still redirect even if logout API fails
        localStorage.clear();
        window.location.href = '/UI/register.html';
    }
}

// Helper functions for profile management
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validatePasswordStrength(password) {
    const minLength = 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    
    return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecial;
}

function updatePasswordStrength(password) {
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');
    const checks = {
        length: document.getElementById('lengthCheck'),
        uppercase: document.getElementById('uppercaseCheck'),
        number: document.getElementById('numberCheck'),
        special: document.getElementById('specialCheck')
    };
    
    const minLength = 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    const isLongEnough = password.length >= minLength;
    
    updateCheckIcon(checks.length, isLongEnough);
    updateCheckIcon(checks.uppercase, hasUpperCase);
    updateCheckIcon(checks.number, hasNumbers);
    updateCheckIcon(checks.special, hasSpecial);
    
    let score = 0;
    if (isLongEnough) score++;
    if (hasUpperCase) score++;
    if (hasNumbers) score++;
    if (hasSpecial) score++;
    
    let strength = 'Weak';
    let color = 'bg-red-500';
    
    if (score >= 4) {
        strength = 'Very Strong';
        color = 'bg-green-500';
    } else if (score >= 3) {
        strength = 'Strong';
        color = 'bg-green-400';
    } else if (score >= 2) {
        strength = 'Medium';
        color = 'bg-yellow-500';
    }
    
    if (strengthBar) {
        strengthBar.className = `h-2 flex-1 rounded-full ${color}`;
        strengthBar.style.width = `${(score / 4) * 100}%`;
    }
    
    if (strengthText) {
        strengthText.textContent = strength;
        strengthText.className = `text-xs ${getStrengthTextColor(score)}`;
    }
    
    return score >= 3;
}

function updateCheckIcon(element, isValid) {
    if (!element) return;
    
    const icon = element.querySelector('i');
    if (icon) {
        if (isValid) {
            icon.className = 'fas fa-check text-green-400 mr-2 text-xs';
        } else {
            icon.className = 'fas fa-times text-red-400 mr-2 text-xs';
        }
    }
}

function getStrengthTextColor(score) {
    if (score >= 4) return 'text-green-400';
    if (score >= 3) return 'text-green-300';
    if (score >= 2) return 'text-yellow-400';
    return 'text-red-400';
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmPassword')?.value;
    const matchElement = document.getElementById('passwordMatch');
    const mismatchElement = document.getElementById('passwordMismatch');
    
    if (!newPassword || !confirmPassword) {
        if (matchElement) matchElement.classList.add('hidden');
        if (mismatchElement) mismatchElement.classList.add('hidden');
        return;
    }
    
    if (newPassword === confirmPassword) {
        if (matchElement) {
            matchElement.classList.remove('hidden');
            if (mismatchElement) mismatchElement.classList.add('hidden');
        }
    } else {
        if (mismatchElement) {
            if (matchElement) matchElement.classList.add('hidden');
            mismatchElement.classList.remove('hidden');
        }
    }
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    const button = input.nextElementSibling;
    if (!button) return;
    
    const icon = button.querySelector('i');
    if (!icon) return;
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function getCurrentMonthYear() {
    const now = new Date();
    return {
        month: now.getMonth() + 1,
        year: now.getFullYear(),
        monthName: now.toLocaleDateString('en-US', { month: 'long' })
    };
}

// Function to validate API response
function validateAttendanceData(data) {
    if (!data || !data.success || !data.data) {
        throw new Error('Invalid data format from API');
    }
    
    // Check if records exist
    if (!Array.isArray(data.data.records)) {
        throw new Error('Invalid records format');
    }
    
    return true;
}

// Function to handle API errors gracefully
async function handleApiError(apiCall) {
    try {
        return await apiCall();
    } catch (error) {
        console.error('API Error:', error);
        
        // Check if it's an authentication error
        if (error.status === 401) {
            showToast('Session expired. Please login again.', 'error');
            setTimeout(() => {
                logout();
            }, 2000);
            throw error;
        }
        
        // Check if it's a network error
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            showToast('Network error. Please check your connection.', 'error');
            throw error;
        }
        
        // For other errors, show generic message
        showToast('Failed to load data. Using fallback data.', 'warning');
        throw error;
    }
}

// Export utility functions globally for HTML onclick handlers
window.setActiveTab = setActiveTab;
window.toggleSidebar = toggleSidebar;
window.toggleUserDropdown = toggleUserDropdown;
window.toggleTheme = toggleTheme;
window.prevMonth = prevMonth;
window.nextMonth = nextMonth;
window.loadCurrentMonthTrend = loadCurrentMonthTrend;
window.loadLastMonthTrend = loadLastMonthTrend;
window.loadQuarterTrend = loadQuarterTrend;
window.filterAttendanceRecords = filterAttendanceRecords;
window.toggleLeaveDuration = toggleLeaveDuration;
window.openNewLeaveModal = openNewLeaveModal;
window.resetLeaveForm = resetLeaveForm;
window.submitLeaveRequest = submitLeaveRequest;
window.viewLeaveRequest = viewLeaveRequest;
window.cancelLeaveRequest = cancelLeaveRequest;
window.refreshDashboard = refreshDashboard;
window.logout = logout;
window.showSection = showSection;
window.togglePasswordVisibility = togglePasswordVisibility;
window.updateProfileName = updateProfileName;
window.updateEmail = updateEmail;
window.changePassword = changePassword;

// Initialize on window load
window.onload = function() {
    if (checkAuth()) {
        setActiveTab('dashboard');
    }
};
</script>
</body>
</html>